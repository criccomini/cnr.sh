<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><base href=/><title>OAuth "Sign In With Google" in a WkWebView | cnr.sh</title><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=block" rel=stylesheet><link href=/css/style.css rel=stylesheet><link href=/css/pygments.css rel=stylesheet><link crossorigin href=https://kit.fontawesome.com/672d96e063.css rel=stylesheet><link href=/rss.xml rel=alternate type=application/rss+xml><link href=/atom.xml rel=alternate type=application/atom+xml><meta content=summary name=twitter:card><meta content="OAuth " a cnr.sh" google" in name=twitter:title sign with wkwebview |><meta content="OAuth " a cnr.sh" google" in property=og:title sign with wkwebview |><meta content=website property=og:type><meta content="When I built WANT, I avoided adding OAuth2 sign-ins at first; I knew it'd be a headache. Instead, I used Devise, Rails's standard authentication framework, to handle email-based sign-ins." name=twitter:description><meta content="When I built WANT, I avoided adding OAuth2 sign-ins at first; I knew it'd be a headache. Instead, I used Devise, Rails's standard authentication framework, to handle email-based sign-ins." property=og:description><meta content=/images/shoes.png name=twitter:image><meta content=/images/shoes.png property=og:image><script crossorigin integrity=sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+ src=https://unpkg.com/htmx.org@2.0.4></script><script async data-uid=46504208bc src=https://cnr.kit.com/46504208bc/index.js></script></head><body hx-boost=true><header><h1><a href=/>cnr.sh</a></h1><nav><ul><li><a href=/posts>Posts</a></li><li><a href=/talks>Talks</a></li></ul></nav></header><main><h1 id=oauth-sign-in-with-google-in-a-wkwebview>OAuth "Sign In With Google" in a WkWebView</h1><p>When I built <a href=https://want.app>WANT</a>, I avoided adding OAuth2 sign-ins at first; I knew it'd be a headache. Instead, I used <a href=https://github.com/heartcombo/devise>Devise</a>, <a href=https://rubyonrails.org/>Rails</a>'s standard authentication framework, to handle email-based sign-ins.</p><p>Some users want to sign in using Google or Apple, though. I eventually added <a href=https://github.com/omniauth/omniauth>OmniAuth</a> to <a href=https://want.app>WANT</a> with the <a href=https://github.com/zquestz/omniauth-google-oauth2>omniauth-google-oauth2</a> and <a href=https://github.com/nhosoya/omniauth-apple>omniauth-apple</a> providers.</p><p>Then I built an iOS mobile app in Swift with Swift UI. The app was a <a href=https://developer.apple.com/documentation/webkit/wkwebview>WkWebView</a> that loaded <a href=https://want.app>https://want.app</a>. This is where my authentication problems with Google started.</p><p>I was seeing this error message when I tried to authenticate with Google in the iOS app:</p><blockquote><p><strong>Error: disallowed_useragent</strong></p><p>This user-agent is not permitted to make OAuth authorisation request to Google as it is classified as an embedded user-agent (also known as a web-view). Per our policy, only browsers are permitted to make authorisation requests to Google. We offer several libraries and samples for native apps to perform authorisation request in browser.</p></blockquote><p>Google doesn't want users authenticating inside embedded browsers like WkWebView. WkWebView allows developers to inject Javascript, read cookies, and otherwise manipulate the browser contents. Such power could enable a nefarious developer to read usernames and passwords as they're entered into <a href=https://accounts.google.com>https://accounts.google.com</a> for the OAuth flow.</p><p><a href=https://stackoverflow.com/questions/53135551/google-disallowed-useragent-in-wkwebview>Most Stack Overflow answers</a> tell you to programmatically change the WkWebView user-agent, which Google is using to detect embedded browsers.</p><div class=highlight><pre><span></span><span class=n>webView</span><span class=p>.</span><span class=n>customUserAgent</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>"Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1"</span><span class=p>;</span>
</pre></div><p>This works, but is a violation of Google's terms of service.</p><p>Auth0 documents better alternatives in their post, <a href=https://auth0.com/blog/google-blocks-oauth-requests-from-embedded-browsers/>Google Blocks OAuth Requests Made Via Embedded Browsers </a>. But all listed solutions all involve an SDK.</p><p>I'm not a mobile developer by trade, and I didn't want to deal with the complexity of a mobile OAuth2 implementation. I already had OAuth working on my website, and I wanted to use it.</p><p>I figured out that you can simply redirect users to Safari for authentication, and use <a href=https://developer.apple.com/ios/universal-links/>universal links</a> to redirect users back to your app (and WkWebView) once they've authenticated. This is how the flow looks:</p><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" title="YouTube video player" allowfullscreen frameborder=0 height=315 src=https://www.youtube.com/embed/5gaVvWc6zyk width=560></iframe><p>This can be done with just a few links of Swift! And it doesn't violate Google's terms of service, since the Google authentication takes place in a standard Safari browser.</p><p>The tap to log into Google redirects users to Safari. This can be done in a <a href=https://developer.apple.com/documentation/webkit/wknavigationdelegate/1455627-webview>WkNavigationDelegate</a> method</p><div class=highlight><pre><span></span><span class=kd>func</span><span class=w> </span><span class=nf>webView</span><span class=p>(</span><span class=kc>_</span><span class=w> </span><span class=n>webView</span><span class=p>:</span><span class=w> </span><span class=bp>WKWebView</span><span class=p>,</span><span class=w> </span><span class=n>didReceiveServerRedirectForProvisionalNavigation</span><span class=w> </span><span class=n>navigation</span><span class=p>:</span><span class=w> </span><span class=bp>WKNavigation</span><span class=p>!)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nv>url</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>webView</span><span class=p>.</span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>.</span><span class=n>absoluteString</span><span class=p>.</span><span class=n>starts</span><span class=p>(</span><span class=n>with</span><span class=p>:</span><span class=w> </span><span class=s>"https://accounts.google.com"</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=bp>UIApplication</span><span class=p>.</span><span class=n>shared</span><span class=p>.</span><span class=n>open</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>:</span><span class=w> </span><span class=p>[:])</span>
<span class=w>  </span><span class=p>}</span>
<span class=p>}</span>
</pre></div><p>The <code>webView</code> method is invoked when the WkWebView receives a redirect. If the URL points to <a href=https://accounts.google.com>https://accounts.google.com</a>, the link is opened in the phone's default browser.</p><p>Once in the default browser, the user can authenticate using their Google account. Best of all, if the user is already logged into Google (as in the video above), the user simply taps the account they wish to log in with.</p><p>From here, Google redirects the user back to your callback. This is where universal linking comes in. In my case, the callback URL is under the <a href=https://want.app>https://want.app</a> domain--the callback that OmniAuth needs.</p><p>Using <a href=https://developer.apple.com/library/archive/documentation/General/Conceptual/AppSearch/UniversalLinks.html>universal links</a>, we can open the redirected callback URL back in the app. Follow the instructions in the previous link to set up universal links for your app. Once that's done, you need to write some code to open the redirected URL in your app's WkWebView.</p><p>First, receive the URL and send a notification.</p><div class=highlight><pre><span></span><span class=n>ContentView</span><span class=p>()</span>
<span class=w>  </span><span class=p>.</span><span class=n>onOpenURL</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>(</span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=k>in</span>
<span class=w>    </span><span class=n>NotificationCenter</span>
<span class=w>      </span><span class=p>.</span><span class=k>default</span>
<span class=w>      </span><span class=p>.</span><span class=n>post</span><span class=p>(</span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=bp>NSNotification</span><span class=p>.</span><span class=n>Name</span><span class=p>(</span><span class=s>"com.app.ios.application.url.opened"</span><span class=p>),</span><span class=w> </span><span class=n>object</span><span class=p>:</span><span class=w> </span><span class=kc>nil</span><span class=p>,</span><span class=w> </span><span class=n>userInfo</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s>"url"</span><span class=p>:</span><span class=w> </span><span class=n>url</span><span class=p>])</span>
<span class=p>}</span>
</pre></div><p>My app uses <a href=https://developer.apple.com/xcode/swiftui/>Swift UI</a>, so it's using <code>onOpenURL</code>. You'll have to Google around if you're using <a href=https://developer.apple.com/documentation/uikit/>UIKit</a>, but it's straight forward.</p><p>Elsewhere in your app (probably in the controller with the WkWebView), receive the URL notification.</p><div class=highlight><pre><span></span><span class=n>NotificationCenter</span><span class=p>.</span><span class=k>default</span><span class=p>.</span><span class=n>addObserver</span><span class=p>(</span><span class=kc>self</span><span class=p>,</span><span class=w> </span><span class=n>selector</span><span class=p>:</span><span class=w> </span><span class=k>#selector</span><span class=p>(</span><span class=kc>self</span><span class=p>.</span><span class=n>urlLoaded</span><span class=p>(</span><span class=n>notification</span><span class=p>:)),</span><span class=w> </span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=n>Notification</span><span class=p>.</span><span class=n>Name</span><span class=p>(</span><span class=s>"com.app.ios.application.url.opened"</span><span class=p>),</span><span class=w> </span><span class=n>object</span><span class=p>:</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span>
</pre></div><p>And load the new URL.</p><div class=highlight><pre><span></span><span class=kr>@objc</span><span class=w> </span><span class=kd>func</span><span class=w> </span><span class=nf>urlLoaded</span><span class=p>(</span><span class=n>notification</span><span class=p>:</span><span class=w> </span><span class=n>Notification</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>  </span><span class=kd>let</span><span class=w> </span><span class=nv>url</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=n>notification</span><span class=p>.</span><span class=n>userInfo</span><span class=p>![</span><span class=s>"url"</span><span class=p>]</span><span class=o>!</span><span class=w> </span><span class=k>as</span><span class=p>!</span><span class=w> </span><span class=n>URL</span>
<span class=w>  </span><span class=kc>self</span><span class=p>.</span><span class=n>webView</span><span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>URLRequest</span><span class=p>(</span><span class=n>url</span><span class=p>:</span><span class=w> </span><span class=n>url</span><span class=p>))</span>
<span class=p>}</span>
</pre></div><p>Now, any URL that your app receives will load into the WkWebView. If you only want to handle callback URLs, not all URLs, you can modify the code to filter out URLs that don't match.</p><p>This approach works because Google's OAuth implementation redirects back to your server using a simple <code>GET</code> request. Forwarding this <code>GET</code> request on to your WkWebView via universal linking means that the OAuth2 callback is loaded in your WkWebView. Loading the callback in your WkWebView means your websites session and cookie data will be stored in the web view, not in Safari's cookie space.</p><p>(NOTE: <a href=https://stackoverflow.com/questions/45098927/how-to-implement-google-login-in-a-wkwebview-switching-to-sfsafariviewcontroller>This Stack Overflow post</a> served as inspiration for my solution.)</p><hr><h4>Changelog</h4><ul><li><strong>Fix redirects</strong> on February 11, 2025</li><li><strong>Migrate to markupdown (#1)</strong> on February 11, 2025</li></ul><hr><script async data-uid=9277dcb391 src=https://cnr.kit.com/9277dcb391/index.js></script></main><script defer src=https://tinylytics.app/embed/DsgFkjZH7dLkhSPiTKbn.js></script></body></html>