<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><base href=/><title>Sorting Reducer Input Values in Hadoop | cnr.sh</title><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=block" rel=stylesheet><link href=/css/style.css rel=stylesheet><link href=/css/pygments.css rel=stylesheet><link crossorigin href=https://kit.fontawesome.com/672d96e063.css rel=stylesheet><link href=/rss.xml rel=alternate type=application/rss+xml><link href=/atom.xml rel=alternate type=application/atom+xml><meta content=summary name=twitter:card><meta content="Sorting Reducer Input Values in Hadoop | cnr.sh" name=twitter:title><meta content="Sorting Reducer Input Values in Hadoop | cnr.sh" property=og:title><meta content=website property=og:type><meta content="I HIGHLY recommend that you read the email thread by Owen O'Malley that describes this technique in brief. I should also note that this example is using the 0.18 Hadoop API." name=twitter:description><meta content="I HIGHLY recommend that you read the email thread by Owen O'Malley that describes this technique in brief. I should also note that this example is using the 0.18 Hadoop API." property=og:description><meta content=/images/shoes.png name=twitter:image><meta content=/images/shoes.png property=og:image><script crossorigin integrity=sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+ src=https://unpkg.com/htmx.org@2.0.4></script><script async data-uid=46504208bc src=https://cnr.kit.com/46504208bc/index.js></script></head><body hx-boost=true><header><h1><a href=/>cnr.sh</a></h1><nav><ul><li><a href=/posts>Posts</a></li><li><a href=/talks>Talks</a></li></ul></nav></header><main><h1 id=sorting-reducer-input-values-in-hadoop>Sorting Reducer Input Values in Hadoop</h1><p>I HIGHLY recommend that you read the email thread by <a href=http://markmail.org/message/7gonm3kiasyh2xnf#query:setOutputKeyComparatorClass+page:3+mid:esn3lgzyx3ag26cy+state:results>Owen O'Malley</a> that describes this technique in brief. I should also note that this example is using the 0.18 Hadoop API.</p><h2 id=sorting-reducer-input-values-in-hadoop_problem-statement>Problem statement</h2><p>Suppose we have a file with a bunch of comma/line separated letters:</p><pre><code>l,f,a,e,a,a,l
f,g,b,c,b,d,f
x,i,t,u,f,e,h
...etc
</code></pre><p>We want our reducer to receive bigrams (lf, fa, ae, ea, aa, al, etc), but partitioned by the first letter, and sorted (ascending) by the second. For example, for the letter a, the reducer should receive:</p><pre><code>&LTa, [l,e,a]>
</code></pre><p>This is actually somewhat difficult to do, since we want to partition by key, but sort the reducer's values iterator. The trick is to have the mapper output the bigram in the key, and only the second letter in the value. For the example above, the mapper would emit:</p><pre><code>&LTae, e>
&LTaa, a>
&LTal, l>
...
</code></pre><p>We can then use a custom partitioner/sorter to partition and sort according to our needs.</p><h2 id=sorting-reducer-input-values-in-hadoop_sorting-by-value>Sorting by value</h2><p>To sort Hadoop's mapper output by value, you need to set three settings in your JobConf:</p><ul><li>setPartitionerClass</li><li>setOutputValueGroupingComparator</li><li>setOutputKeyComparatorClass</li></ul><p>There are many threads that say that you can't sort by value in Hadoop. This is true. What you can do, instead, is have your mapper output all data in the key, rather than the value. Then you can use a specialized Partitioner classes and two RawComparator classes to sort and partition your map output properly.</p><h2 id=sorting-reducer-input-values-in-hadoop_partitioner>Partitioner</h2><p>The first class that you need to set is a class that extends org.apache.hadoop.mapred.Partitioner. This class has a single function that determines which partition your map output should go to. This means that you can't go below 0, or above numPartitions - 1. Mostly, you'll want to hashCode() some portion of your key and mod it by numPartitions.</p><p>In our example, the partitioner will partition by the first letter of the key.</p><h2 id=sorting-reducer-input-values-in-hadoop_output-value-grouping-comparator>Output value grouping comparator</h2><p>The OutputValueGroupingComparator JobConf setting takes in a org.apache.hadoop.io.RawComparator. This RawComparator is used to determine which reducer the mapper output row should go to. This RawComparator does not sort a reducer's value iterator. Instead, it's used to sort reducer input, so that the reducer knows when a new grouping starts.</p><p>In our example, the value grouping comparator will sort by the first letter of the key.</p><h2 id=sorting-reducer-input-values-in-hadoop_output-key-comparator>Output key comparator</h2><p>The OutputKeyComparatorClass JobConf setting also takes in a org.apache.hadoop.io.RawComparator. This RawComparator is used to sort the values iterator that the reducer gets, which is what we want. It should be noted, that although the RawComparator is used to sort the values iterator, the data that gets passed into the comparator is the mapper key output. This is the reason that we must put all data in the key as well as the value.</p><p>A <em>very</em> important thing to note is that they key compartor must also enforce the value grouping comparator's rules. In our example, this means that it must first check if the first letter is equal. If it's not equal, it should return the same ruls as the value comparator. Only if the first letter of the key is equal should we apply our value-level sorting (comparing the second letter). If you do not do this, you will break your grouping.</p><p>In our example, the key comparator will sort by the second letter of the key.</p><h2 id=sorting-reducer-input-values-in-hadoop_running-the-job>Running the job</h2><p>Now, all we need to do is run the job.</p><div class=highlight><pre><span></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SortReducerByValues</span><span class=w> </span><span class=p>{</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>INPUT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"/tmp/data_in"</span><span class=p>;</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>OUTPUT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>"/tmp/data_out"</span><span class=p>;</span>
<span class=w>	</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
<span class=w>		</span><span class=k>new</span><span class=w> </span><span class=n>SortReducerByValues</span><span class=p>().</span><span class=na>run</span><span class=p>();</span>
<span class=w>	</span><span class=p>}</span>
<span class=w>	</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
<span class=w>		</span><span class=n>JobConf</span><span class=w> </span><span class=n>conf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JobConf</span><span class=p>();</span>
<span class=w>		</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setInputFormat</span><span class=p>(</span><span class=n>SequenceFileInputFormat</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setOutputFormat</span><span class=p>(</span><span class=n>SequenceFileOutputFormat</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=w>		</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setMapOutputKeyClass</span><span class=p>(</span><span class=n>Text</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setMapOutputValueClass</span><span class=p>(</span><span class=n>Text</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>

<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setOutputKeyClass</span><span class=p>(</span><span class=n>Text</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setOutputValueClass</span><span class=p>(</span><span class=n>Text</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>

<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setMapperClass</span><span class=p>(</span><span class=n>SortReducerByValuesMapper</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setReducerClass</span><span class=p>(</span><span class=n>SortReducerByValuesReducer</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>

<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setOutputKeyComparatorClass</span><span class=p>(</span><span class=n>SortReducerByValuesKeyComparator</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setOutputValueGroupingComparator</span><span class=p>(</span><span class=n>SortReducerByValuesValueGroupingComparator</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>setPartitionerClass</span><span class=p>(</span><span class=n>SortReducerByValuesPartitioner</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>

<span class=w>		</span><span class=n>FileInputFormat</span><span class=p>.</span><span class=na>addInputPath</span><span class=p>(</span><span class=n>conf</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Path</span><span class=p>(</span><span class=n>INPUT</span><span class=p>));</span>
<span class=w>		</span><span class=n>FileOutputFormat</span><span class=p>.</span><span class=na>setOutputPath</span><span class=p>(</span><span class=n>conf</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Path</span><span class=p>(</span><span class=n>OUTPUT</span><span class=p>));</span>
<span class=w>		</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>getWorkingDirectory</span><span class=p>().</span><span class=na>getFileSystem</span><span class=p>(</span><span class=n>conf</span><span class=p>).</span><span class=na>delete</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Path</span><span class=p>(</span><span class=n>INPUT</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span>
<span class=w>		</span><span class=n>conf</span><span class=p>.</span><span class=na>getWorkingDirectory</span><span class=p>().</span><span class=na>getFileSystem</span><span class=p>(</span><span class=n>conf</span><span class=p>).</span><span class=na>delete</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Path</span><span class=p>(</span><span class=n>OUTPUT</span><span class=p>),</span><span class=w> </span><span class=kc>true</span><span class=p>);</span>
<span class=w>		</span>
<span class=w>		</span><span class=n>loadFakeData</span><span class=p>(</span><span class=n>INPUT</span><span class=p>);</span>
<span class=w>		</span>
<span class=w>		</span><span class=n>JobClient</span><span class=p>.</span><span class=na>runJob</span><span class=p>(</span><span class=n>conf</span><span class=p>).</span><span class=na>waitForCompletion</span><span class=p>();</span>
<span class=w>	</span><span class=p>}</span>
<span class=w>	</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>SortReducerByValuesKeyComparator</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>RawComparator</span><span class=w> </span><span class=p>{</span>
<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>compare</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>text1</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>start1</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>length1</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>text2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>start2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>length2</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>			</span><span class=c1>// hadoop gives you an extra byte before text data. get rid of it.</span>
<span class=w>			</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>trimmed1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span><span class=p>;</span>
<span class=w>			</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>trimmed2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=mi>2</span><span class=o>]</span><span class=p>;</span>
<span class=w>			</span><span class=n>System</span><span class=p>.</span><span class=na>arraycopy</span><span class=p>(</span><span class=n>text1</span><span class=p>,</span><span class=w> </span><span class=n>start1</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>trimmed1</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span>
<span class=w>			</span><span class=n>System</span><span class=p>.</span><span class=na>arraycopy</span><span class=p>(</span><span class=n>text2</span><span class=p>,</span><span class=w> </span><span class=n>start2</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>trimmed2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>);</span>
<span class=w>			</span>
<span class=w>			</span><span class=kt>char</span><span class=w> </span><span class=n>char10</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=n>trimmed1</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
<span class=w>			</span><span class=kt>char</span><span class=w> </span><span class=n>char20</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=n>trimmed2</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
<span class=w>			</span><span class=kt>char</span><span class=w> </span><span class=n>char11</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=n>trimmed1</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
<span class=w>			</span><span class=kt>char</span><span class=w> </span><span class=n>char21</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=p>)</span><span class=n>trimmed2</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
<span class=w>			</span>
<span class=w>			</span><span class=c1>// first enforce the same rules as the value grouping comparator</span>
<span class=w>			</span><span class=c1>// (first letter of key)</span>
<span class=w>			</span><span class=kt>int</span><span class=w> </span><span class=n>compare</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Character</span><span class=p>(</span><span class=n>char10</span><span class=p>).</span><span class=na>compareTo</span><span class=p>(</span><span class=n>char20</span><span class=p>);</span>
<span class=w>			</span>
<span class=w>			</span><span class=k>if</span><span class=p>(</span><span class=n>compare</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>				</span><span class=c1>// ONLY if we're in the same reduce aggregate should we try and</span>
<span class=w>				</span><span class=c1>// sort by value (second letter of key)</span>
<span class=w>				</span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Character</span><span class=p>(</span><span class=n>char11</span><span class=p>).</span><span class=na>compareTo</span><span class=p>(</span><span class=n>char21</span><span class=p>);</span>
<span class=w>			</span><span class=p>}</span>
<span class=w>			</span>
<span class=w>			</span><span class=k>return</span><span class=w> </span><span class=n>compare</span><span class=p>;</span>
<span class=w>		</span><span class=p>}</span>

<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>compare</span><span class=p>(</span><span class=n>Text</span><span class=w> </span><span class=n>o1</span><span class=p>,</span><span class=w> </span><span class=n>Text</span><span class=w> </span><span class=n>o2</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>			</span><span class=c1>// reverse the +1 since the extra text byte is not passed into</span>
<span class=w>			</span><span class=c1>// compare() from this function</span>
<span class=w>			</span><span class=k>return</span><span class=w> </span><span class=n>compare</span><span class=p>(</span><span class=n>o1</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=na>getLength</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>o2</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>o2</span><span class=p>.</span><span class=na>getLength</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
<span class=w>		</span><span class=p>}</span>
<span class=w>	</span><span class=p>}</span>
<span class=w>	</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>SortReducerByValuesPartitioner</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Partitioner</span><span class=w> </span><span class=p>{</span>
<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getPartition</span><span class=p>(</span><span class=n>Text</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Text</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>numPartitions</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>			</span><span class=c1>// just partition by the first character of each key since that's</span>
<span class=w>			</span><span class=c1>// how we are grouping for the reducer</span>
<span class=w>			</span><span class=k>return</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>toString</span><span class=p>().</span><span class=na>charAt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>numPartitions</span><span class=p>;</span>
<span class=w>		</span><span class=p>}</span>

<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>JobConf</span><span class=w> </span><span class=n>conf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span>
<span class=w>	</span><span class=p>}</span>
<span class=w>	</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>SortReducerByValuesValueGroupingComparator</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>RawComparator</span><span class=w> </span><span class=p>{</span>
<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>compare</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>text1</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>start1</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>length1</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>text2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>start2</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>length2</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>			</span><span class=c1>// look at first character of each text byte array</span>
<span class=w>			</span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Character</span><span class=p>((</span><span class=kt>char</span><span class=p>)</span><span class=n>text1</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>).</span><span class=na>compareTo</span><span class=p>((</span><span class=kt>char</span><span class=p>)</span><span class=n>text2</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>);</span>
<span class=w>		</span><span class=p>}</span>

<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>compare</span><span class=p>(</span><span class=n>Text</span><span class=w> </span><span class=n>o1</span><span class=p>,</span><span class=w> </span><span class=n>Text</span><span class=w> </span><span class=n>o2</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>			</span><span class=k>return</span><span class=w> </span><span class=n>compare</span><span class=p>(</span><span class=n>o1</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=na>getLength</span><span class=p>(),</span><span class=w> </span><span class=n>o2</span><span class=p>.</span><span class=na>getBytes</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>o2</span><span class=p>.</span><span class=na>getLength</span><span class=p>());</span>
<span class=w>		</span><span class=p>}</span>
<span class=w>	</span><span class=p>}</span>
<span class=w>	</span>
<span class=w>	</span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>loadFakeData</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>path</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
<span class=w>		</span><span class=n>JobConf</span><span class=w> </span><span class=n>conf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JobConf</span><span class=p>();</span>
<span class=w>		</span><span class=n>Writer</span><span class=w> </span><span class=n>writer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SequenceFile</span><span class=p>.</span><span class=na>createWriter</span><span class=p>(</span><span class=n>FileSystem</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>conf</span><span class=p>),</span><span class=w> </span><span class=n>conf</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Path</span><span class=p>(</span><span class=n>path</span><span class=p>),</span><span class=w> </span><span class=n>Text</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Text</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=w>		</span>
<span class=w>		</span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o><</span><span class=w> </span><span class=mi>100</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>			</span><span class=n>String</span><span class=w> </span><span class=n>letterCSV</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>""</span><span class=p>;</span>
<span class=w>			</span>
<span class=w>			</span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o><</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>j</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>				</span><span class=n>letterCSV</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=p>)(</span><span class=mi>65</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=n>Math</span><span class=p>.</span><span class=na>random</span><span class=p>()</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>26</span><span class=p>))</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>","</span><span class=p>;</span>
<span class=w>			</span><span class=p>}</span>

<span class=w>			</span><span class=n>writer</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Text</span><span class=p>(),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Text</span><span class=p>(</span><span class=n>letterCSV</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>letterCSV</span><span class=p>.</span><span class=na>length</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)));</span>
<span class=w>		</span><span class=p>}</span>
<span class=w>		</span>
<span class=w>		</span><span class=n>writer</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
<span class=w>	</span><span class=p>}</span>
<span class=w>	</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>SortReducerByValuesMapper</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Mapper</span><span class=w> </span><span class=p>{</span>
<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>map</span><span class=p>(</span><span class=n>Text</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Text</span><span class=w> </span><span class=n>val</span><span class=p>,</span>
<span class=w>				</span><span class=n>OutputCollector</span><span class=w> </span><span class=n>collector</span><span class=p>,</span><span class=w> </span><span class=n>Reporter</span><span class=w> </span><span class=n>reporter</span><span class=p>)</span>
<span class=w>				</span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
<span class=w>			</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>chars</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>val</span><span class=p>.</span><span class=na>toString</span><span class=p>().</span><span class=na>split</span><span class=p>(</span><span class=s>","</span><span class=p>);</span>
<span class=w>			</span>
<span class=w>			</span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o><</span><span class=w> </span><span class=n>chars</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>				</span><span class=n>collector</span><span class=p>.</span><span class=na>collect</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Text</span><span class=p>(</span><span class=n>chars</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>chars</span><span class=o>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=o>]</span><span class=p>),</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Text</span><span class=p>(</span><span class=n>chars</span><span class=o>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=o>]</span><span class=p>));</span>
<span class=w>			</span><span class=p>}</span>
<span class=w>		</span><span class=p>}</span>
<span class=w>		</span>
<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>JobConf</span><span class=w> </span><span class=n>conf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span>
<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>close</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span>
<span class=w>	</span><span class=p>}</span>
<span class=w>	</span>
<span class=w>	</span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>SortReducerByValuesReducer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Reducer</span><span class=w> </span><span class=p>{</span>

<span class=w>		</span><span class=nd>@Override</span>
<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>reduce</span><span class=p>(</span><span class=n>Text</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Iterator</span><span class=w> </span><span class=n>values</span><span class=p>,</span>
<span class=w>				</span><span class=n>OutputCollector</span><span class=w> </span><span class=n>collector</span><span class=p>,</span><span class=w> </span><span class=n>Reporter</span><span class=w> </span><span class=n>reporter</span><span class=p>)</span>
<span class=w>				</span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
<span class=w>			</span><span class=c1>// values should now be in order</span>
<span class=w>			</span><span class=n>String</span><span class=w> </span><span class=n>check</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>": "</span><span class=p>;</span>
<span class=w>			</span>
<span class=w>			</span><span class=k>while</span><span class=p>(</span><span class=n>values</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
<span class=w>				</span><span class=n>check</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>values</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
<span class=w>			</span><span class=p>}</span>
<span class=w>			</span>
<span class=w>			</span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>check</span><span class=p>);</span>
<span class=w>		</span><span class=p>}</span>

<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=n>JobConf</span><span class=w> </span><span class=n>conf</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span>
<span class=w>		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>close</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span>
<span class=w>	</span><span class=p>}</span>
<span class=p>}</span>
</pre></div><h2 id=sorting-reducer-input-values-in-hadoop_output>Output</h2><p>As you can see, the reducer input is grouped by the first letter (our logical key), and the values are sorted ascending.</p><pre><code>AY: YWUTSSSRRQPPPPOMMKJIIIFB
BZ: ZYYXXXWVUUURRRRQPPPPPPOONMMLLKJHGEEDDBB
CZ: ZZZZZYYXXWVUUUTSSSRQQOOMKKKHHHGGFFDDCCCBB
DY: YXWWSSQQPPPONMMKIHGEDDCCBB
EW: WVUTRRRQPOOOOONMLLKKKJJHFEEDDCCBA
FY: YXXXWVVVUUTSSRPNNNLLKJHGFFECBBBBA
GZ: ZZYXVTSQQPOONLJIHHHFFCCCBBA
HZ: ZYYYYXWVUUTTTRQQPOOMKJJIIIGFEDAAAA
IY: YYYXWWVVVUTTSRRRQMKJJJIIIHGGFFEEEECBBBA
JZ: ZZYYXXWRRRQPPOOOMLJJIIHHHHCCCBBA
KZ: ZZYXWWVSSSSRQONMJIIHFEDB
LZ: ZZZYYXXWUTRQQQPLKJIIIHHGGFDDCCCBBBAA
MZ: ZZYYYWTTTSSQQQQOJIIIHGGFCCCBBAA
NZ: ZZYYXVVUTSSSSRQPNMKIHGFFFECAA
OZ: ZZZYYXWWUSRRPPOONNNMMLJIIHHHGGFEEEDDCCBA
PZ: ZXXWWTSSSSSRRRQQQMMLLLKJIIIHEEDCBA
QZ: ZZYXWWWWWWVVVUTTSSSSRRRRQQQPOOONMLKJIHHFDD
RY: YYYXXXWVUURRQQPPOOOLLLLLLKJJJJHHHHGFFEEEDDCCCBAA
SY: YXWWWVVVUUUTTSRRRQQQNNNMLJHHHGGGGFEDDCCCBB
TZ: ZZYYYYXXWVTTTTSRRQPPONNNNMMLLJIIIICBB
UZ: ZZZYXWWVVVSRRRQPPONMHHGEDCBBA
VZ: ZYWVVUTTTQPPPOOMKIIGFEEDDCCCBB
WX: XWWWVUTTSSSRRPNNNMMLLKKKKKJJIGEDAAAA
XZ: ZZYXXXXSSRRQQOOMLLKKJIIIIHGFFEDDBA
YZ: ZZZYXWWVUUUTTTSSRQPPPOONNNMLJIIFFFFEDCCCAA
ZZ: ZYYWVVUUTSSSSRRQQQPOONMMLLLJJIIGFDBBBA
</code></pre><h2 id=sorting-reducer-input-values-in-hadoop_links>Links</h2><ul><li><a href=http://markmail.org/message/7gonm3kiasyh2xnf#query:setOutputKeyComparatorClass+page:3+mid:esn3lgzyx3ag26cy+state:results>Owen O'Malley's Value Sorting Email</a></li><li><a href=http://issues.apache.org/jira/secure/attachment/12356648/485.patch>Hadoop Value Grouping Example Patch</a></li><li><a href=https://issues.apache.org/jira/browse/HADOOP-4545>Secondary Sort Hadoop Example</a></li></ul><hr><h4>Changelog</h4><ul><li><strong>Fix redirects</strong> on February 11, 2025</li><li><strong>Migrate to markupdown (#1)</strong> on February 11, 2025</li></ul><hr><script async data-uid=9277dcb391 src=https://cnr.kit.com/9277dcb391/index.js></script></main><script defer src=https://tinylytics.app/embed/DsgFkjZH7dLkhSPiTKbn.js></script></body></html>