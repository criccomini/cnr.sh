<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="date" content='2009-11-13'>
<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"/>
<meta property="og:type" content="website" />
<meta property="og:title" content="Sorting Reducer Input Values in
Hadoop" />
<meta property="og:description" content="I HIGHLY recommend that you
read the email thread by Owen O'Malley that describes this technique in
brief. I should also note that this example is using the 0.18 Hadoop
API. " />
<meta property="og:image" content="https://cnr.sh/img/og-img.png" /><link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ’¬</text></svg>">
<link rel="alternate" type="application/rss+xml" href="https://cnr.sh/rss.xml" title="Chris Riccomini's RSS Feed"><title>Sorting
Reducer Input Values in Hadoop | Chris Riccomini</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Roboto+Condensed:wght@700&display=swap');
body {padding: 1.25rem 0em; margin: 0em; font-family: 'Lora', serif; font-size: 14pt; line-height: 1.75;}
h1, h2, h3, h4 {font-family: 'Roboto Condensed', sans-serif; margin: 0em; line-height: 1.25;}
h1 {font-size: 30pt;}
a {color: #ff0080; text-decoration: none; font-weight: bold;}
pre > code {overflow-x: auto; width: 100%; display: inline-block;}
div.home {position: fixed; font-size: 15pt; padding: .5em; line-height: 0em; background-color: #333;}
div.social {position: fixed; font-size: 15pt; padding: .5em; line-height: 0em; right: 1.5em;}
div.title {text-align: center;}
div.main {width: 32em; margin: 0em auto;}
div.intro {width: 30em; margin: 0em auto;}
div.article:first-letter {float: left; margin: .125em .25em; font-size: 4em; line-height: 1;}
div.links {width: 40em; margin: 0em auto;}
div.links table {border-spacing: 0em 0em; margin: 1em 0em;}
div.links td.link-date {text-align: right; width: 10em; padding-right: .5em; vertical-align: top;}
div.links span.link-date {display: none;}
i.social {color: #ccc;}
i.home {color: white;}
div.intro p:first-of-type {font-size: 22pt;}
div.article p:first-of-type {font-size: 18pt;}
div.article blockquote > p:first-of-type {font-size: 14pt;}
div.article img {width: 100%;}
div.promo {margin: 0rem auto 1.25rem auto; width: 50rem; font-family: helvetica; text-align: center; top: 0px; left: 0px; background-color: black; color: white; font-size: .925rem; letter-spacing: .075rem; padding: .5em;}
@media screen and (min-width : 0px) and (max-width : 767px){
body {padding: 0em;}
div.main {width: auto; padding: 4em 2em;}
div.intro {width: auto; padding: 0em 3em;}
div.home {position: absolute;}
div.social {display: none;}
span.by {display: block; margin-top: .5em;}
div.links {padding-top: 1em; width: auto; padding: 4em 2em;}
div.links td.link-date {display: none;}
div.links span.link-date {display: block;}
div.links table {border-spacing: 0em 1em; margin: 0em;}
div.promo {width: auto; padding: 1rem 4rem; }
}</style>
<script src="https://kit.fontawesome.com/672d96e063.js" crossorigin="anonymous"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-3R91BN0RW0"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-3R91BN0RW0');
</script></head>
<body>
<div class="home">
<a href="/"><i class="home fas fa-home"></i></a>
</div>
<div class="social">
<a href="https://twitter.com/criccomini"><i class="social fab fa-twitter"></i></a>
</div><div class="main">
<div class="title">
<h1>Sorting Reducer Input Values in Hadoop</h1>
<span class="by">Chris Riccomini on November 13, 2009</span>
</div>
<div class="article">
<p>I HIGHLY recommend that you read the email thread by <a
href="http://markmail.org/message/7gonm3kiasyh2xnf#query:setOutputKeyComparatorClass+page:3+mid:esn3lgzyx3ag26cy+state:results">Owen
Oâ€™Malley</a> that describes this technique in brief. I should also note
that this example is using the 0.18 Hadoop API.</p>
<h2 id="problem-statement">Problem statement</h2>
<p>Suppose we have a file with a bunch of comma/line separated
letters:</p>
<pre><code>l,f,a,e,a,a,l
f,g,b,c,b,d,f
x,i,t,u,f,e,h
...etc</code></pre>
<p>We want our reducer to receive bigrams (lf, fa, ae, ea, aa, al, etc),
but partitioned by the first letter, and sorted (ascending) by the
second. For example, for the letter a, the reducer should receive:</p>
<pre><code>&lt;a, [l,e,a]&gt;</code></pre>
<p>This is actually somewhat difficult to do, since we want to partition
by key, but sort the reducerâ€™s values iterator. The trick is to have the
mapper output the bigram in the key, and only the second letter in the
value. For the example above, the mapper would emit:</p>
<pre><code>&lt;ae, e&gt;
&lt;aa, a&gt;
&lt;al, l&gt;
...</code></pre>
<p>We can then use a custom partitioner/sorter to partition and sort
according to our needs.</p>
<h2 id="sorting-by-value">Sorting by value</h2>
<p>To sort Hadoopâ€™s mapper output by value, you need to set three
settings in your JobConf:</p>
<ul>
<li>setPartitionerClass</li>
<li>setOutputValueGroupingComparator</li>
<li>setOutputKeyComparatorClass</li>
</ul>
<p>There are many threads that say that you canâ€™t sort by value in
Hadoop. This is true. What you can do, instead, is have your mapper
output all data in the key, rather than the value. Then you can use a
specialized Partitioner classes and two RawComparator classes to sort
and partition your map output properly.</p>
<h2 id="partitioner">Partitioner</h2>
<p>The first class that you need to set is a class that extends
org.apache.hadoop.mapred.Partitioner. This class has a single function
that determines which partition your map output should go to. This means
that you canâ€™t go below 0, or above numPartitions - 1. Mostly, youâ€™ll
want to hashCode() some portion of your key and mod it by
numPartitions.</p>
<p>In our example, the partitioner will partition by the first letter of
the key.</p>
<h2 id="output-value-grouping-comparator">Output value grouping
comparator</h2>
<p>The OutputValueGroupingComparator JobConf setting takes in a
org.apache.hadoop.io.RawComparator. This RawComparator is used to
determine which reducer the mapper output row should go to. This
RawComparator does not sort a reducerâ€™s value iterator. Instead, itâ€™s
used to sort reducer input, so that the reducer knows when a new
grouping starts.</p>
<p>In our example, the value grouping comparator will sort by the first
letter of the key.</p>
<h2 id="output-key-comparator">Output key comparator</h2>
<p>The OutputKeyComparatorClass JobConf setting also takes in a
org.apache.hadoop.io.RawComparator. This RawComparator is used to sort
the values iterator that the reducer gets, which is what we want. It
should be noted, that although the RawComparator is used to sort the
values iterator, the data that gets passed into the comparator is the
mapper key output. This is the reason that we must put all data in the
key as well as the value.</p>
<p>A <em>very</em> important thing to note is that they key compartor
must also enforce the value grouping comparatorâ€™s rules. In our example,
this means that it must first check if the first letter is equal. If
itâ€™s not equal, it should return the same ruls as the value comparator.
Only if the first letter of the key is equal should we apply our
value-level sorting (comparing the second letter). If you do not do
this, you will break your grouping.</p>
<p>In our example, the key comparator will sort by the second letter of
the key.</p>
<h2 id="running-the-job">Running the job</h2>
<p>Now, all we need to do is run the job.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> SortReducerByValues <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> INPUT <span class="op">=</span> <span class="st">&quot;/tmp/data_in&quot;</span><span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> OUTPUT <span class="op">=</span> <span class="st">&quot;/tmp/data_out&quot;</span><span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span><span class="op">(</span><span class="bu">String</span><span class="op">[]</span> args<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">new</span> <span class="fu">SortReducerByValues</span><span class="op">().</span><span class="fu">run</span><span class="op">();</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        JobConf conf <span class="op">=</span> <span class="kw">new</span> <span class="fu">JobConf</span><span class="op">();</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setInputFormat</span><span class="op">(</span>SequenceFileInputFormat<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setOutputFormat</span><span class="op">(</span>SequenceFileOutputFormat<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setMapOutputKeyClass</span><span class="op">(</span><span class="bu">Text</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setMapOutputValueClass</span><span class="op">(</span><span class="bu">Text</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setOutputKeyClass</span><span class="op">(</span><span class="bu">Text</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setOutputValueClass</span><span class="op">(</span><span class="bu">Text</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setMapperClass</span><span class="op">(</span>SortReducerByValuesMapper<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setReducerClass</span><span class="op">(</span>SortReducerByValuesReducer<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setOutputKeyComparatorClass</span><span class="op">(</span>SortReducerByValuesKeyComparator<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setOutputValueGroupingComparator</span><span class="op">(</span>SortReducerByValuesValueGroupingComparator<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">setPartitionerClass</span><span class="op">(</span>SortReducerByValuesPartitioner<span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        FileInputFormat<span class="op">.</span><span class="fu">addInputPath</span><span class="op">(</span>conf<span class="op">,</span> <span class="kw">new</span> <span class="fu">Path</span><span class="op">(</span>INPUT<span class="op">));</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        FileOutputFormat<span class="op">.</span><span class="fu">setOutputPath</span><span class="op">(</span>conf<span class="op">,</span> <span class="kw">new</span> <span class="fu">Path</span><span class="op">(</span>OUTPUT<span class="op">));</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">getWorkingDirectory</span><span class="op">().</span><span class="fu">getFileSystem</span><span class="op">(</span>conf<span class="op">).</span><span class="fu">delete</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Path</span><span class="op">(</span>INPUT<span class="op">),</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        conf<span class="op">.</span><span class="fu">getWorkingDirectory</span><span class="op">().</span><span class="fu">getFileSystem</span><span class="op">(</span>conf<span class="op">).</span><span class="fu">delete</span><span class="op">(</span><span class="kw">new</span> <span class="fu">Path</span><span class="op">(</span>OUTPUT<span class="op">),</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">loadFakeData</span><span class="op">(</span>INPUT<span class="op">);</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        JobClient<span class="op">.</span><span class="fu">runJob</span><span class="op">(</span>conf<span class="op">).</span><span class="fu">waitForCompletion</span><span class="op">();</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="kw">class</span> SortReducerByValuesKeyComparator <span class="kw">implements</span> RawComparator <span class="op">{</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">int</span> <span class="fu">compare</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> text1<span class="op">,</span> <span class="dt">int</span> start1<span class="op">,</span> <span class="dt">int</span> length1<span class="op">,</span> <span class="dt">byte</span><span class="op">[]</span> text2<span class="op">,</span> <span class="dt">int</span> start2<span class="op">,</span> <span class="dt">int</span> length2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>            <span class="co">// hadoop gives you an extra byte before text data. get rid of it.</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> trimmed1 <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>            <span class="dt">byte</span><span class="op">[]</span> trimmed2 <span class="op">=</span> <span class="kw">new</span> <span class="dt">byte</span><span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">arraycopy</span><span class="op">(</span>text1<span class="op">,</span> start1<span class="op">+</span><span class="dv">1</span><span class="op">,</span> trimmed1<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">arraycopy</span><span class="op">(</span>text2<span class="op">,</span> start2<span class="op">+</span><span class="dv">1</span><span class="op">,</span> trimmed2<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> char10 <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">)</span>trimmed1<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> char20 <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">)</span>trimmed2<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> char11 <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">)</span>trimmed1<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>            <span class="dt">char</span> char21 <span class="op">=</span> <span class="op">(</span><span class="dt">char</span><span class="op">)</span>trimmed2<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>            <span class="co">// first enforce the same rules as the value grouping comparator</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>            <span class="co">// (first letter of key)</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>            <span class="dt">int</span> compare <span class="op">=</span> <span class="kw">new</span> <span class="bu">Character</span><span class="op">(</span>char10<span class="op">).</span><span class="fu">compareTo</span><span class="op">(</span>char20<span class="op">);</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span><span class="op">(</span>compare <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>                <span class="co">// ONLY if we&#39;re in the same reduce aggregate should we try and</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                <span class="co">// sort by value (second letter of key)</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span> <span class="op">*</span> <span class="kw">new</span> <span class="bu">Character</span><span class="op">(</span>char11<span class="op">).</span><span class="fu">compareTo</span><span class="op">(</span>char21<span class="op">);</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> compare<span class="op">;</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">int</span> <span class="fu">compare</span><span class="op">(</span><span class="bu">Text</span> o1<span class="op">,</span> <span class="bu">Text</span> o2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>            <span class="co">// reverse the +1 since the extra text byte is not passed into</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>            <span class="co">// compare() from this function</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">compare</span><span class="op">(</span>o1<span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> o1<span class="op">.</span><span class="fu">getLength</span><span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> o2<span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> o2<span class="op">.</span><span class="fu">getLength</span><span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="kw">class</span> SortReducerByValuesPartitioner <span class="kw">implements</span> Partitioner <span class="op">{</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">int</span> <span class="fu">getPartition</span><span class="op">(</span><span class="bu">Text</span> key<span class="op">,</span> <span class="bu">Text</span> value<span class="op">,</span> <span class="dt">int</span> numPartitions<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>            <span class="co">// just partition by the first character of each key since that&#39;s</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>            <span class="co">// how we are grouping for the reducer</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> key<span class="op">.</span><span class="fu">toString</span><span class="op">().</span><span class="fu">charAt</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span> <span class="op">%</span> numPartitions<span class="op">;</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">configure</span><span class="op">(</span>JobConf conf<span class="op">)</span> <span class="op">{</span> <span class="op">}</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="kw">class</span> SortReducerByValuesValueGroupingComparator <span class="kw">implements</span> RawComparator <span class="op">{</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">int</span> <span class="fu">compare</span><span class="op">(</span><span class="dt">byte</span><span class="op">[]</span> text1<span class="op">,</span> <span class="dt">int</span> start1<span class="op">,</span> <span class="dt">int</span> length1<span class="op">,</span> <span class="dt">byte</span><span class="op">[]</span> text2<span class="op">,</span> <span class="dt">int</span> start2<span class="op">,</span> <span class="dt">int</span> length2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>            <span class="co">// look at first character of each text byte array</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Character</span><span class="op">((</span><span class="dt">char</span><span class="op">)</span>text1<span class="op">[</span><span class="dv">0</span><span class="op">]).</span><span class="fu">compareTo</span><span class="op">((</span><span class="dt">char</span><span class="op">)</span>text2<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">int</span> <span class="fu">compare</span><span class="op">(</span><span class="bu">Text</span> o1<span class="op">,</span> <span class="bu">Text</span> o2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fu">compare</span><span class="op">(</span>o1<span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> o1<span class="op">.</span><span class="fu">getLength</span><span class="op">(),</span> o2<span class="op">.</span><span class="fu">getBytes</span><span class="op">(),</span> <span class="dv">0</span><span class="op">,</span> o2<span class="op">.</span><span class="fu">getLength</span><span class="op">());</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">loadFakeData</span><span class="op">(</span><span class="bu">String</span> path<span class="op">)</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        JobConf conf <span class="op">=</span> <span class="kw">new</span> <span class="fu">JobConf</span><span class="op">();</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Writer</span> writer <span class="op">=</span> SequenceFile<span class="op">.</span><span class="fu">createWriter</span><span class="op">(</span>FileSystem<span class="op">.</span><span class="fu">get</span><span class="op">(</span>conf<span class="op">),</span> conf<span class="op">,</span> <span class="kw">new</span> <span class="fu">Path</span><span class="op">(</span>path<span class="op">),</span> <span class="bu">Text</span><span class="op">.</span><span class="fu">class</span><span class="op">,</span> <span class="bu">Text</span><span class="op">.</span><span class="fu">class</span><span class="op">);</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">100</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> letterCSV <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> <span class="op">++</span>j<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>                letterCSV <span class="op">+=</span> <span class="op">(</span><span class="dt">char</span><span class="op">)(</span><span class="dv">65</span> <span class="op">+</span> <span class="op">(</span><span class="dt">int</span><span class="op">)(</span><span class="bu">Math</span><span class="op">.</span><span class="fu">random</span><span class="op">()</span> <span class="op">*</span> <span class="dv">26</span><span class="op">))</span> <span class="op">+</span> <span class="st">&quot;,&quot;</span><span class="op">;</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>            writer<span class="op">.</span><span class="fu">append</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Text</span><span class="op">(),</span> <span class="kw">new</span> <span class="bu">Text</span><span class="op">(</span>letterCSV<span class="op">.</span><span class="fu">substring</span><span class="op">(</span><span class="dv">0</span><span class="op">,</span> letterCSV<span class="op">.</span><span class="fu">length</span><span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">)));</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>        writer<span class="op">.</span><span class="fu">close</span><span class="op">();</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="kw">class</span> SortReducerByValuesMapper <span class="kw">implements</span> Mapper <span class="op">{</span></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">map</span><span class="op">(</span><span class="bu">Text</span> key<span class="op">,</span> <span class="bu">Text</span> val<span class="op">,</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>                OutputCollector collector<span class="op">,</span> Reporter reporter<span class="op">)</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span><span class="op">[]</span> chars <span class="op">=</span> val<span class="op">.</span><span class="fu">toString</span><span class="op">().</span><span class="fu">split</span><span class="op">(</span><span class="st">&quot;,&quot;</span><span class="op">);</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span><span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> chars<span class="op">.</span><span class="fu">length</span> <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>                collector<span class="op">.</span><span class="fu">collect</span><span class="op">(</span><span class="kw">new</span> <span class="bu">Text</span><span class="op">(</span>chars<span class="op">[</span>i<span class="op">]</span> <span class="op">+</span> chars<span class="op">[</span>i<span class="op">+</span><span class="dv">1</span><span class="op">]),</span> <span class="kw">new</span> <span class="bu">Text</span><span class="op">(</span>chars<span class="op">[</span>i<span class="op">+</span><span class="dv">1</span><span class="op">]));</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">configure</span><span class="op">(</span>JobConf conf<span class="op">)</span> <span class="op">{</span> <span class="op">}</span></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">close</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span> <span class="op">}</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="kw">class</span> SortReducerByValuesReducer <span class="kw">implements</span> Reducer <span class="op">{</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Override</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">reduce</span><span class="op">(</span><span class="bu">Text</span> key<span class="op">,</span> <span class="bu">Iterator</span> values<span class="op">,</span></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>                OutputCollector collector<span class="op">,</span> Reporter reporter<span class="op">)</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>                <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>            <span class="co">// values should now be in order</span></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>            <span class="bu">String</span> check <span class="op">=</span> key <span class="op">+</span> <span class="st">&quot;: &quot;</span><span class="op">;</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span><span class="op">(</span>values<span class="op">.</span><span class="fu">hasNext</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>                check <span class="op">+=</span> values<span class="op">.</span><span class="fu">next</span><span class="op">();</span></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>            <span class="bu">System</span><span class="op">.</span><span class="fu">err</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span>check<span class="op">);</span></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">configure</span><span class="op">(</span>JobConf conf<span class="op">)</span> <span class="op">{</span> <span class="op">}</span></span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">close</span><span class="op">()</span> <span class="kw">throws</span> <span class="bu">IOException</span> <span class="op">{</span> <span class="op">}</span></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="output">Output</h2>
<p>As you can see, the reducer input is grouped by the first letter (our
logical key), and the values are sorted ascending.</p>
<pre><code>AY: YWUTSSSRRQPPPPOMMKJIIIFB
BZ: ZYYXXXWVUUURRRRQPPPPPPOONMMLLKJHGEEDDBB
CZ: ZZZZZYYXXWVUUUTSSSRQQOOMKKKHHHGGFFDDCCCBB
DY: YXWWSSQQPPPONMMKIHGEDDCCBB
EW: WVUTRRRQPOOOOONMLLKKKJJHFEEDDCCBA
FY: YXXXWVVVUUTSSRPNNNLLKJHGFFECBBBBA
GZ: ZZYXVTSQQPOONLJIHHHFFCCCBBA
HZ: ZYYYYXWVUUTTTRQQPOOMKJJIIIGFEDAAAA
IY: YYYXWWVVVUTTSRRRQMKJJJIIIHGGFFEEEECBBBA
JZ: ZZYYXXWRRRQPPOOOMLJJIIHHHHCCCBBA
KZ: ZZYXWWVSSSSRQONMJIIHFEDB
LZ: ZZZYYXXWUTRQQQPLKJIIIHHGGFDDCCCBBBAA
MZ: ZZYYYWTTTSSQQQQOJIIIHGGFCCCBBAA
NZ: ZZYYXVVUTSSSSRQPNMKIHGFFFECAA
OZ: ZZZYYXWWUSRRPPOONNNMMLJIIHHHGGFEEEDDCCBA
PZ: ZXXWWTSSSSSRRRQQQMMLLLKJIIIHEEDCBA
QZ: ZZYXWWWWWWVVVUTTSSSSRRRRQQQPOOONMLKJIHHFDD
RY: YYYXXXWVUURRQQPPOOOLLLLLLKJJJJHHHHGFFEEEDDCCCBAA
SY: YXWWWVVVUUUTTSRRRQQQNNNMLJHHHGGGGFEDDCCCBB
TZ: ZZYYYYXXWVTTTTSRRQPPONNNNMMLLJIIIICBB
UZ: ZZZYXWWVVVSRRRQPPONMHHGEDCBBA
VZ: ZYWVVUTTTQPPPOOMKIIGFEEDDCCCBB
WX: XWWWVUTTSSSRRPNNNMMLLKKKKKJJIGEDAAAA
XZ: ZZYXXXXSSRRQQOOMLLKKJIIIIHGFFEDDBA
YZ: ZZZYXWWVUUUTTTSSRQPPPOONNNMLJIIFFFFEDCCCAA
ZZ: ZYYWVVUUTSSSSRRQQQPOONMMLLLJJIIGFDBBBA</code></pre>
<h2 id="links">Links</h2>
<ul>
<li><a
href="http://markmail.org/message/7gonm3kiasyh2xnf#query:setOutputKeyComparatorClass+page:3+mid:esn3lgzyx3ag26cy+state:results">Owen
Oâ€™Malleyâ€™s Value Sorting Email</a></li>
<li><a
href="http://issues.apache.org/jira/secure/attachment/12356648/485.patch">Hadoop
Value Grouping Example Patch</a></li>
<li><a
href="https://issues.apache.org/jira/browse/HADOOP-4545">Secondary Sort
Hadoop Example</a></li>
</ul>
</div>
<div style="padding: 1em; text-align: center; border: 2px solid #eee;">
<h1><label for="tlemail">Never Miss a Post</label></h1>
<span class="by">Subscribe to my newsletter!</span>
<iframe src="https://materializedview.io/embed" height="320" style="margin-top: 1rem; width: 100%;" frameborder="0" scrolling="no"></iframe>
</p>
</div></div>
</body>
</html>